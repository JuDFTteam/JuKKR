SHELL = /bin/sh

include ./makeflags

SRAOBJS = $(OBJ)/bofm.o          $(OBJ)/btom.o      $(OBJ)/cinit.o \
          $(OBJ)/beshan.o        $(OBJ)/dlke0.o     $(OBJ)/dlke1.o \
          $(OBJ)/inversion.o     $(OBJ)/invslab.o                  \
          $(OBJ)/invsupercell.o  $(OBJ)/ioinput.o   $(OBJ)/ioben.o    \
          $(OBJ)/mapblock.o      $(OBJ)/opt.o       $(OBJ)/rcstop.o  \
          $(OBJ)/surfgf.o        $(OBJ)/test.o      $(OBJ)/ymy.o \
          $(OBJ)/grefsy.o \

SRANONMPI = $(OBJ)/dclock.o

COMOBJS = \
          $(OBJ)/kloopz1.o      $(OBJ)/decimate.o \
          $(OBJ)/projtau.o      $(OBJ)/cpamillsx.o   $(OBJ)/rotate.o \
          $(OBJ)/getdmat.o      $(OBJ)/mssinit.o     $(OBJ)/rotgll.o \
          $(OBJ)/tbxccpljij.o   $(OBJ)/calctref.o    $(OBJ)/cmatmul.o \
          $(OBJ)/initabjij.o    $(OBJ)/setfactl.o    $(OBJ)/gijdmat.o \
          $(OBJ)/rotatespinframe.o \
	  $(OBJ)/symetrmat.o    $(OBJ)/getscratch.o  $(OBJ)/lngstring.o 

COMNONMPI = $(OBJ)/main1b.o     $(OBJ)/kkrmat01.o     

MPIOBJ = $(OBJ)/mpimain1b.o $(OBJ)/mpikkrmat01.o $(OBJ)/mpidclock.o

RELOBJS = $(OBJ)/changerep.o     $(OBJ)/cmatstr.o

PROGOBJS = $(COMOBJS) $(COMNONMPI) $(SRAOBJS) $(SRANONMPI) $(RELOBJS)

MPIOBJS = $(MPIOBJ) $(COMOBJS) $(SRAOBJS) $(RELOBJS)

setmpi:
	@if test ! -d MPI;\
	then mkdir MPI; fi
	rm -f $(OBJ)/mpi*.o
	cp -p inc.p   ./MPI/inc.p
	cp -p inc.cls ./MPI/inc.cls

mkdirobj:
	@if test ! -d $(OBJ); \
	then mkdir $(OBJ); fi

clean:
	@find . -name "*.o" -exec rm -f {} \;
copyinc:
	cp -p inc.p   $(SRA)/inc.p
	cp -p inc.p   $(COM)/inc.p
	cp -p inc.cls $(SRA)/inc.cls
	cp -p inc.cls $(COM)/inc.cls

kkr : mkdirobj copyinc $(PROGOBJS)
	$(LD) -o $(BIN)/kkr1b.exe $(PROGOBJS) $(libs) 

kkrmpi : mkdirobj setmpi copyinc $(MPIOBJS)
	$(LDMPI) -o $(BIN)/kkr1b_mpi.exe $(MPIOBJS) $(libs) 

###################################################################
# rules expressing dependencies on Fortran files

##################### sources in SRA directory ##########
$(OBJ)/grefsy.o   : $(SRA)/grefsy.f                 ; \
	              $(FC) $(FFLAGS) $(SRA)/grefsy.f -c -o $@

$(OBJ)/bofm.o         : $(SRA)/bofm.f                     ; \
                       $(FC) $(FFLAGS)  $(SRA)/bofm.f -c -o $@

$(OBJ)/btom.o         : $(SRA)/btom.f                     ; \
                       $(FC) $(FFLAGS)  $(SRA)/btom.f -c -o $@

$(OBJ)/beshan.o       : $(SRA)/beshan.f                   ; \
                       $(FC) $(FFLAGS)  $(SRA)/beshan.f -c -o $@

$(OBJ)/cinit.o        : $(SRA)/cinit.f                    ; \
                       $(FC) $(FFLAGS)  $(SRA)/cinit.f -c -o $@

$(OBJ)/dclock.o       : $(SRA)/dclock.f                   ; \
                       $(FC) $(FFLAGS)  $(SRA)/dclock.f -c -o $@

$(OBJ)/dlke0.o        : $(SRA)/dlke0.f  $(INCP)    ; \
                       $(FC) $(FFLAGS)  $(SRA)/dlke0.f -c -o $@

$(OBJ)/dlke1.o        : $(SRA)/dlke1.f  $(INCP)    ; \
                       $(FC) $(FFLAGS)  $(SRA)/dlke1.f -c -o $@

$(OBJ)/inversion.o    : $(SRA)/inversion.f $(INCP)        ; \
                       $(FC) $(FFLAGS)  $(SRA)/inversion.f -c -o $@

$(OBJ)/invslab.o      : $(SRA)/invslab.f   $(INCP)        ; \
                       $(FC) $(FFLAGS)  $(SRA)/invslab.f -c -o $@

$(OBJ)/invsupercell.o : $(SRA)/invsupercell.f $(INCP)     ; \
                       $(FC) $(FFLAGS)  $(SRA)/invsupercell.f -c -o $@

$(OBJ)/ioinput.o      : $(SRA)/ioinput.f                  ; \
                       $(FC) $(FFLAGS)  $(SRA)/ioinput.f -c -o $@

$(OBJ)/ioben.o        : $(SRA)/ioben.f                    ; \
                       $(FC) $(FFLAGS)  $(SRA)/ioben.f -c -o $@

$(OBJ)/mapblock.o     : $(SRA)/mapblock.f                 ; \
                       $(FC) $(FFLAGS)  $(SRA)/mapblock.f -c -o $@

$(OBJ)/opt.o          : $(SRA)/opt.f                      ; \
                       $(FC) $(FFLAGS)  $(SRA)/opt.f -c -o $@

$(OBJ)/rcstop.o       : $(SRA)/rcstop.f                   ; \
                       $(FC) $(FFLAGS)  $(SRA)/rcstop.f -c -o $@

$(OBJ)/surfgf.o       : $(SRA)/surfgf.f $(INCP)           ; \
                       $(FC) $(FFLAGS)  $(SRA)/surfgf.f -c -o $@

$(OBJ)/test.o         : $(SRA)/test.f                     ; \
                       $(FC) $(FFLAGS)  $(SRA)/test.f -c -o $@

$(OBJ)/ymy.o          : $(SRA)/ymy.f                      ; \
                       $(FC) $(FFLAGS)  $(SRA)/ymy.f -c -o $@

############################################################

##################### sources in COMMON directory ##########

$(OBJ)/main1b.o   : $(COM)/main1b.f  $(INCP) ; \
	            $(FC) $(FFLAGS) $(COM)/main1b.f -c -o $@

$(OBJ)/kloopz1.o  : $(COM)/kloopz1.f  $(INCP)  ; \
                    $(FC) $(FFLAGS)  $(COM)/kloopz1.f -c -o $@

$(OBJ)/mssinit.o  : $(COM)/mssinit.f                  ; \
                    $(FC) $(FFLAGS)  $(COM)/mssinit.f -c -o $@

$(OBJ)/kkrmat01.o : $(COM)/kkrmat01.f $(INCP)  ; \
                    $(FC) $(FFLAGS)  $(COM)/kkrmat01.f -c -o $@

$(OBJ)/decimate.o     : $(COM)/decimate.f $(INCP)  ; \
                       $(FC) $(FFLAGS)  $(COM)/decimate.f -c -o $@

$(OBJ)/rotgll.o       : $(COM)/rotgll.f                    ; \
                       $(FC) $(FFLAGS)  $(COM)/rotgll.f -c -o $@

$(OBJ)/tbxccpljij.o : $(COM)/tbxccpljij.f               ; \
                    $(FC) $(FFLAGS)   $(COM)/tbxccpljij.f -c -o $@

$(OBJ)/calctref.o   : $(COM)/calctref.f                 ; \
                    $(FC) $(FFLAGS)   $(COM)/calctref.f -c -o $@

$(OBJ)/cmatmul.o    : $(COM)/cmatmul.f                  ; \
                    $(FC) $(FFLAGS)   $(COM)/cmatmul.f -c -o $@

$(OBJ)/initabjij.o   : $(COM)/initabjij.f               ; \
                    $(FC) $(FFLAGS)   $(COM)/initabjij.f -c -o $@

$(OBJ)/setfactl.o    : $(COM)/setfactl.f               ; \
                    $(FC) $(FFLAGS)   $(COM)/setfactl.f -c -o $@

$(OBJ)/gijdmat.o     : $(COM)/gijdmat.f               ; \
                    $(FC) $(FFLAGS)   $(COM)/gijdmat.f -c -o $@

$(OBJ)/symetrmat.o   : $(COM)/symetrmat.f             ; \
                    $(FC) $(FFLAGS)   $(COM)/symetrmat.f -c -o $@

$(OBJ)/getscratch.o  : $(COM)/getscratch.f     ; \
	               $(FC) $(FFLAGS) $(COM)/getscratch.f -c -o $@

$(OBJ)/lngstring.o  : $(COM)/lngstring.f     ; \
	               $(FC) $(FFLAGS) $(COM)/lngstring.f -c -o $@

$(OBJ)/rotatespinframe.o  : $(COM)/rotatespinframe.f90    ; \
                    $(FC) $(FFLAGS) $(COM)/rotatespinframe.f90 -c -o $@

#################### sources in COM directory stemming ########
#################### from Munich SPR-KKR program       ########

$(OBJ)/projtau.o    : $(COM)/projtau.f                  ; \
                    $(FC) $(FFLAGS)  $(COM)/projtau.f -c -o $@

$(OBJ)/cpamillsx.o  : $(COM)/cpamillsx.f                  ; \
                    $(FC) $(FFLAGS)  $(COM)/cpamillsx.f -c -o $@

$(OBJ)/rotate.o     : $(COM)/rotate.f                  ; \
                    $(FC) $(FFLAGS)  $(COM)/rotate.f -c -o $@

$(OBJ)/getdmat.o    : $(COM)/getdmat.f                  ; \
                    $(FC) $(FFLAGS)  $(COM)/getdmat.f -c -o $@

############################################################

##################### sources in REL directory ##########
$(OBJ)/changerep.o   : $(REL)/changerep.f               ; \
	             $(FC) $(FFLAGS) $(REL)/changerep.f -c -o $@

$(OBJ)/cmatstr.o     : $(REL)/cmatstr.f                ; \
	             $(FC) $(FFLAGS) $(REL)/cmatstr.f -c -o $@

############################################################

##################### MPI OBJ MPI OBJ ##########

$(OBJ)/mpimain1b.o   : $(COM)/main1b.f $(INCP) 
	cat $(COM)/main1b.f | sed 's/CMPI /     /' > ./MPI/mpimain1b.f
	$(FC) $(FFLAGS) ./MPI/mpimain1b.f -c -o $@	

$(OBJ)/mpikkrmat01.o  : $(COM)/kkrmat01.f $(INCP) 
	cat $(COM)/kkrmat01.f | sed 's/CMPI /     /' > ./MPI/mpikkrmat01.f
	$(FC) $(FFLAGS) ./MPI/mpikkrmat01.f -c -o $@

$(OBJ)/mpidclock.o    : $(SRA)/dclock.f
	cat $(SRA)/dclock.f | sed 's/CMPI /     /' > ./MPI/mpidclock.f
	$(FC) $(FFLAGS) ./MPI/mpidclock.f -c -o $@

############################################################
